@startuml
' Отключаем кружки у связей и задаём ортогональные линии
hide circle
skinparam linetype ortho
skinparam shadowing false

' Шрифты и размеры
skinparam entityFontName Arial
skinparam entityFontSize 12

' Стиль сущностей
skinparam entity {
  BackgroundColor #E8F5E9
  BorderColor #388E3C
  FontColor #1B5E20
}

' Расположение слева направо
left to right direction

' Пользователи
entity users {
  * id           : BIGSERIAL <<PK>>
  --
  * username     : VARCHAR(50)  <<UNIQUE>>
  * password_hash: VARCHAR(255)
  * email        : VARCHAR(100) <<UNIQUE>>
  * created_at   : TIMESTAMP
  * updated_at   : TIMESTAMP
}

' Математические модели
entity models {
  * id                     : BIGSERIAL <<PK>>
  --
  * user_id                : BIGINT    <<FK users.id>>
  * name                   : VARCHAR(100)
  * description            : TEXT
  * visualization_settings : JSONB
  * created_at             : TIMESTAMP
  * updated_at             : TIMESTAMP
}

entity parameters {
  * id            : BIGSERIAL <<PK>>
  --
  * name          : VARCHAR(100)
  * description   : TEXT
  * default_value : DOUBLE PRECISION
  * created_at    : TIMESTAMP
}

entity model_parameters {
  * model_id     : BIGINT <<PK,FK models.id>>
  * parameter_id : BIGINT <<PK,FK parameters.id>>
  --
  * value        : DOUBLE PRECISION
}

' Расчёты и визуализации
entity calculations {
  * id           : BIGSERIAL <<PK>>
  --
  * model_id     : BIGINT    <<FK models.id>>
  * input_data   : JSONB
  * result_data  : JSONB
  * created_at   : TIMESTAMP
}

entity visualizations {
  * id             : BIGSERIAL <<PK>>
  --
  * calculation_id : BIGINT    <<FK calculations.id>>
  * graph_type     : VARCHAR(50)
  * graph_data     : JSONB
  * settings       : JSONB
  * created_at     : TIMESTAMP
}

' Симуляции
entity simulation_types {
  * id          : BIGSERIAL <<PK>>
  --
  * name        : VARCHAR(50)
  * description : TEXT
}

entity simulations {
  * id           : UUID       <<PK>>
  --
  * user_id      : BIGINT     <<FK users.id>>
  * type_id      : BIGINT     <<FK simulation_types.id>>
  * input_data   : JSONB
  * result_data  : JSONB
  * created_at   : TIMESTAMP
}

entity agents {
  * id             : BIGSERIAL <<PK>>
  --
  * user_id        : BIGINT    <<FK users.id>>
  * name           : VARCHAR(100)
  * behavior_model : JSONB
  * created_at     : TIMESTAMP
}

' Документы (модельные и финансовые)
entity documents {
  * id             : BIGSERIAL <<PK>>
  --
  * user_id        : BIGINT    <<FK users.id>>
  * model_id       : BIGINT    <<FK models.id>>      <<NULL>>
  * simulation_id  : UUID      <<FK simulations.id>>  <<NULL>>
  * document_type  : VARCHAR(20) <<ENUM(MODEL_DOC,FIN_REPORT)>>
  * file_path      : VARCHAR(255)
  * uploaded_at    : TIMESTAMP
}

' Экспорты / Сохранённые отчёты
entity reports {
  * id            : BIGSERIAL <<PK>>
  --
  * user_id       : BIGINT    <<FK users.id>>
  * model_id      : BIGINT    <<FK models.id>>      <<NULL>>
  * simulation_id : UUID      <<FK simulations.id>>  <<NULL>>
  * report_type   : VARCHAR(50) <<ENUM(CALCULATION,COMPARISON,SIMULATION)>>
  * name          : VARCHAR(100)
  * file_path     : VARCHAR(255)
  * created_at    : TIMESTAMP
}

' Сравнение идеального и реального
entity comparisons {
  * id         : BIGSERIAL <<PK>>
  --
  * user_id    : BIGINT    <<FK users.id>>
  * model_id   : BIGINT    <<FK models.id>>
  * report_id  : BIGINT    <<FK reports.id>>
  * ideal_data : JSONB
  * real_data  : JSONB
  * created_at : TIMESTAMP
}

' AI-анализ документов и отчётов
entity model_analyses {
  * id            : BIGSERIAL <<PK>>
  --
  * model_id      : BIGINT    <<FK models.id>>
  * analysis_type : VARCHAR(50)
  * result_data   : JSONB
  * created_at    : TIMESTAMP
}

entity report_analyses {
  * id            : BIGSERIAL <<PK>>
  --
  * report_id     : BIGINT    <<FK reports.id>>
  * analysis_type : VARCHAR(50)
  * result_data   : JSONB
  * created_at    : TIMESTAMP
}

entity simulation_analyses {
  * id            : BIGSERIAL <<PK>>
  --
  * simulation_id : UUID      <<FK simulations.id>>
  * analysis_type : VARCHAR(50)
  * result_data   : JSONB
  * created_at    : TIMESTAMP
}

'--- Связи ---
users               ||--o{ models
users               ||--o{ simulations
users               ||--o{ agents
users               ||--o{ documents
users               ||--o{ reports
users               ||--o{ comparisons

models              ||--o{ model_parameters
parameters          ||--o{ model_parameters

models              ||--o{ calculations
calculations        ||--o{ visualizations

simulation_types    ||--o{ simulations
simulations         ||--o{ simulation_analyses

models              ||--o{ model_analyses
reports             ||--o{ report_analyses

models              ||--o{ documents
simulations         ||--o{ documents

models              ||--o{ reports
simulations         ||--o{ reports

models              ||--o{ comparisons
reports             ||--o{ comparisons

@enduml
